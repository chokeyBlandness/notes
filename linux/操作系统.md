## 一、概述

### 1、什么是操作系统

操作系统（Operation System），是管理计算机**硬件**和**软件**的**计算机程序**。

主要作用：

- 管理与配置内存
- 决定系统资源供需的优先次序
- 控制输入设备与输出设备
- 操作网络与管理文件系统等基本事务
- 提供一个让用户与系统交互的界面

OS的四个基本特征：

- 并发（同一时间间隔内执行和调度多个程序的能力。并发性为其他特性的前提）
- 共享（资源共享，系统中的资源供多个并发执行的应用程序共同使用）
- 虚拟（使用某种技术把一个物理实体变成多个逻辑上的对应物。时分复用即使、空分复用技术）
- 异步（多道程序环境下，允许多个程序并发执行；单处理机环境下，多个程序分时交替执行）

并发和共享互为存在的前提条件

### 2、运行机制

- 时钟管理
  - 计时：提供系统时间
  - 时钟中断：比如进程切换
- 中断机制（提高多道程序环境下CPU利用率。外中断、内中断）
- 原语（由若干条指令组成的一个程序段，用来完成某个特定功能，具有原子性）
- 系统数据结构
  - 进程管理：作业控制块
  - 存储器管理：存储器分配与回收
  - 设备管理：缓冲区、设备控制块
- 系统调用（应用程序访问内核服务的方式，是一套接口的集合）

内终端的三种情况

- 陷阱/陷入（trap）：用应用程序主动引发。
- 故障（fault）：由错误条件引发。
- 种植（abort）：由致命错误引发。

中断处理过程

![中断处理过程](..\pictures\中断处理过程.png)

## 二、进程管理

### 1、进程的概念

**进程（Process）**：是一个具有一定独立功能的程序关于某个数据集合的一次运行活动，是系统进行资源分配和调度的一个独立单位。是OS中资源分配的最小单位。

进程的结构：控制块（PCB），数据段、程序段。

进程的特征：

- 动态性：由创建而生，由撤销而亡
- 并发性：多个进程同时运行
- 独立性：独立资源分配
- 异步性：相互独立、互不干扰

**线程（Thread）**：轻量级进程，是一系列活动按实现设定好的顺序依次执行的过程，是一系列指令的集合。是OS中运算调度的最小单位。

线程的引入提高了OS的并发性。

线程的属性：

- 轻型实体
- 独立调度和分派的基本单位
- 可并发执行
- 共享进程资源

**线程相对于进程，大大降低了创建、撤销和切换可执行实体的成本和难度。**

线程的实现方式：用户级线程、内核级线程。

### 2、进程的运行机制

#### 2.1 进程的状态

就绪（Ready）、执行（Running）、阻塞（Blocked）

OS通过原语操作实现进程控制。

- 创建原语：create
- 阻塞原语：block
- 唤醒原语：wakeup
- 撤销原语：destroy
- 挂起原语：suspend
  - 静止就绪状态：放外存，不调度
  - 静止阻塞状态：等待事件
- 激活原语：active
  - 活动就绪状态：等待调度
  - 活动阻塞状态：等待唤醒

进程状态流转图

![进程状态流转图](..\pictures\进程状态流转图.png)

#### 2.2 处理机调度

根据一定的算法和原则，将处理机资源进行重新分配的过程。

处理级调度层次：

- 高级调度（作业调度）：把后备作业调入内存。
- 中级调度（内存调度）：将进程调至外村，条件合适再调入内存。
- 低级调度（进程调度）：从就绪队列选取进程分配给处理机。

处理机调度方式：

- 剥夺式/抢占式调度：立即暂停当前进程，分配处理机给另一个进程。
- 非剥夺/非抢占式调度：等待当前进程完成或阻塞后，分配处理机给另一个进程。适用于批处理系统，不适用分时、实时系统。

处理机调度过程：

1. 保存镜像：记录进程线程信息
2. 调度算法：确定分配处理机的原则
3. 进程切换：分配处理机给其他进程
4. 处理机回收：从进程回收处理机

进程调度算法指标：

- CPU利用率：忙碌时间/总时间
- 系统吞吐量：完成作业数/总时间
- 周转时间：作业完成时间-提交时间
- 等待时间：作业等待处理机调度时间
- 响应时间：提交请求到首次响应的间隔

#### 2.3 进程调度算法

##### 2.3.1 先来先服务（FCFS，First Come First Served）

算法内容：调度作业/就绪队列中最先入队者，等待操作完成或阻塞

算法原则：按作业/进程到达顺序服务（执行）

调度方式：非抢占式调度

适用场景：作业／进程调度

优点：有利于ＣＰＵ繁忙型作业，充分利用ＣＰＵ资源

缺点：不利于Ｉ／Ｏ繁忙型作业，操作耗时。

##### 2.3.2 短作业优先（SJF，Shortest Job Fist）

算法内容：所需服务时间最短的作业/进程优先服务

算法原则：追求最少的平均周转时间

调度方式：非抢占式调度

适用场景：作业／进程调度

优点：平均等待/周转时间最少

缺点：长作业周转时间会增加或饥饿。不能保证迫切任务即时执行。

##### 2.3.3 高响应比优先调度（HRRN，Highest Response Ratio Next）

算法内容：结合FCFS和SJF，综合考虑等待时间和服务时间计算响应比，高的优先调度

算法原则：综合考虑作业/进程的等待时间和服务时间

调度方式：非抢占式调度

适用场景：作业／进程调度

优点：长作业等待越久响应比越高，更容易获得处理机

缺点：只有当前进程放弃执行权（完成/阻塞）时，重新计算所有进程响应比

##### 2.3.4 优先级调度（PAS，Priority-Scheduling Algorithm）

算法内容：按作业/进程的优先级（紧迫程度）进行调度

算法原则：优先级最高（最紧迫）的作业/进程先调度

调度方式：抢占/非抢占式调度

适用场景：作业／进程调度

优点：可优先执行优先级高的进程

缺点：低优先级的进程可能产生饥饿

##### 2.3.5 时间片轮转调度（RR，Round-Robin）

算法内容：按进程到达就绪队列的顺序，轮流分配一个时间片去执行，时间用完则剥夺

算法原则：公平、轮流为每个进程服务，进程在一定时间内都能得到响应

调度方式：抢占式，由时钟中断确定时间片

适用场景：进程调度

优点：公平。响应快，适用于分时系统

缺点：时间片太大，相当于FCFS；太小，处理机切换频繁，开销增大

> 时间片决定因素：系统响应时间、就绪队列进程数量、系统处理能力

##### 2.3.6 多级反馈队列调度（MFQ，Multileveled Feedback Queue）

算法内容：
设置多个按优先级排序的就绪队列，
优先级从高到底，时间片从小到大，
新进程采用队列降级法，
前面队列不为空，不执行后续队列进程。

算法原则：集前几种算法优点，相当于PSA+RR

调度方式：抢占式

适用场景：进程调度

优缺点：

- 对各类型相对公平；快速响应；
- 终端型作业用户：短作业优先；
- 批处理作业用户：周转时间短；
- 长批处理作业用户：在前几个队列部分执行

### 3、进程间的协作

#### 3.1 进程通信

进程通信即进程间的信息交换。

- 共享存储：基于共享数据结构的通信方式（低级通信，可以传递少量数据，效率低）和基于共享存储区的通信方式（高级通信，可以传递大量数据，效率高）
- 消息传递：直接通信（点到点发送）和间接通信（广播信箱）
- 管道通信：双工/半双工

#### 3.2 进程同步

协调进程间的相互制约关系，使它们按照预取的方式执行的过程。互斥地访问临界资源。

互斥访问临界资源的过程：

1. 进入区：尝试进入临界区，成功则加锁
2. 临界区：访问共享资源
3. 退出区：解锁，唤醒其他阻塞进程
4. 剩余区：其他代码

访问原则：

- 空闲让进：临界区空闲，允许一个进程进入
- 忙则等待：临界区已有进程，其他进程等待（阻塞）
- 有限等待：处于等待的进程，等待时间有限
- 让权等待：等待时应让出CPU执行权，防止忙等待

软件实现方式：

- 单标志法：违背“空闲让进”
- 双标志法先检查：违背“忙则等待”
- 双标志后检查：违背“空闲让进”、“有限等待”
- 皮特森算法：违背“让权等待”，会发生忙等

硬件实现方式：

- 中断屏蔽方法
- TS指令/TSL指令
- Swap指令

信号量机制：PV操作

管程：管理程序，即用于实现进程同步的工具。是由代表共享资源的数据结构和一组过程（进行PV操作的函数）组成的管理程序。

### 4、死锁

多个进程由于竞争资源而造成的阻塞现象，若无外力作用，这些进程将无法继续推进。

死锁产生的原因：系统资源的竞争、进程推进顺序非法。

死锁产生的必要条件：

- 互斥条件：共享资源的排他性访问
- 不可剥夺条件：访问时该共享资源不会被剥夺
- 请求与保持条件：保持当前资源时请求另一个资源
- 循环等待条件：存在共享资源的循环等待链

死锁的解除：

- 资源剥夺
- 撤销进程
- 进程回退
