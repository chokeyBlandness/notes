# 分布式事务

### 一、2PC

两阶段提交协议（Two-Phase Commit，2PC），是一种经常使用到的解决分布式事务的方案。

事务分为两个阶段。通过事务协调者来协调整体事务。

1. 准备阶段（Prepare phase）：事务管理器给每个参与者发送Prepare消息，每个数据库参与者在本地执行事务，并写本地的Undo/Redo日志，此时事务没有提交。
2. 提交阶段（Commit phase）：如果事务管理器收到了参与者的执行失败或者超时消息时，直接给每个参与者发送回滚(Rollback)消息；否则，发送提交(Commit)消息；参与者根据事务管理器的指令执行提交或者回滚操作，并释放事务处理过程中使用的资源。

**缺点**：

1、单点故障。协调者TC故障事务会出错。——协调者高可用部署

2、阻塞资源。占用数据库连接，性能低。——第一阶段直接提交并释放资源，记录回滚状态；当第二阶段commit时不操作，rollback时再执行回滚逻辑。例如seata对2PC的优化，补偿记录undoLog。

3、数据不一致。第二阶段出错，数据不一致。——人工补偿

### 二、3PC

三阶段提交，在2PC的基础上进行了优化演变。

引入了超时机制，并将2PC的第一阶段分为两部分，保证了最后提交阶段之前，各参与节点的状态是一致的。

相对于2PC，3PC主要解决了协调者宕机之后事务阻塞的问题，因为一旦参与者无法及时收到来自协调者的信息之后，他会默认执行commit。而不会一直持有事务资源并处于阻塞状态。

一般2PC就能够解决大部分的分布式事务了。

1. CanCommit阶段：协调者询问参与者是否可以执行事务操作。此时并没有执行事务。
2. PreCommit阶段：根据第一阶段的反馈，如果反馈失败，直接失败；如果反馈成功，发送事务预提交，记录RedoLog/UndoLog，对资源加锁。
3. DoCommit阶段：执行事务提交或者回滚。如果参与者超时未接收到协调者的反馈，默认是执行commit，因为经过前两步，大概率是需要commit的，这是个概率事件。

### 三、TCC

TCC是Try、Confirm、Cancel的缩写，TCC要求每个分支事务实现这三个操作接口。

### 四、Seata

seata中分布式事务有四种模式：AT、XA、TCC、SAGA。

代码无侵入式为AT、XA。

seata部署时，如果是db模式，需要新建三张表：

1、branch_table 分支事务表，记录分支事务信息。

2、global_table 全局事务表，记录全局事务信息。

3、lock_table 全局锁表，实现全局事务锁。

#### AT模式

该模式使用的最多，通过拦截解析SQL语句来实现。最终一致的，并不是强一致。

需要额外创建一张undoLog表，来记录第一阶段需要回滚的sql。当要执行rollback时，通过XID（全局事务ID）在undoLog表中找到对应的回滚语句，进行补偿回滚。

#### XA模式

该模式的提交回滚并不是补偿式的，而是交由数据库实现。

#### TCC模式

该模式需要自己实现Try、Confirm、Cancel的业务逻辑，以满足自定义事务逻辑的需求。

#### SAGA模式

该模式可异构，主要针对一些无法变动的老项目、不同语言的项目。该模式要求分支事务的应用在原有事务接口的基础上，在开放一个回滚接口，以便协调者通过这两个接口进行调用。